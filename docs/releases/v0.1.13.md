# v0.1.13 - macOS Command-Line Fidelity Fix & Binding Coverage

**Release Date:** 2026-02-13
**Status:** macOS Command-Line Fidelity Fix & Binding Coverage

## Summary

This release fixes a high-severity bug where `processList()` returned truncated `cmdline` on macOS (just the process name instead of the full argument vector), breaking downstream consumers that filter by command-line arguments. It also exports v0.1.12 process tree capabilities to the FFI layer and Go/TypeScript bindings.

## Highlights

- **macOS cmdline fix**: `cmdline` now returns the full argument vector (e.g. `["bun", "run", "scripts/dev.ts", "--root", "/path"]`) instead of `["bun"]`
- **FFI coverage**: `descendants` and `kill-descendants` now available through C-ABI FFI
- **Go binding**: `Descendants()` and `KillDescendants()` with option pattern
- **TypeScript binding**: `descendants()` and `killDescendants()` via N-API

## Changes

### Bug Fix: macOS `cmdline` Truncation

**Before (v0.1.12):**
```json
{"pid": 12345, "name": "bun", "cmdline": ["bun"]}
```

**After (v0.1.13):**
```json
{"pid": 12345, "name": "bun", "cmdline": ["bun", "run", "scripts/dev.ts", "--root", "/some/path"]}
```

**Root cause:** The macOS implementation used `proc_name()` as a placeholder for `cmdline`, which only returns the process name (16 chars max). The fix uses `sysctl(CTL_KERN, KERN_PROCARGS2)` — the same kernel API that `ps` uses — to read the actual argv.

**Impact:** Any consumer filtering by `cmdline` arguments on macOS was affected. Known affected: kitfly `discoverOrphans()` which filters by `p.cmdline.some(arg => arg.includes("scripts/dev.ts"))`.

**Implementation details:**
- Two-stage `sysctl` call: first with null buffer to query required size, then with allocated buffer to read data
- Parses the `KERN_PROCARGS2` buffer format: `[argc: i32][exec_path\0][padding \0s][argv[0]\0][argv[1]\0]...`
- Uses `String::from_utf8_lossy()` for non-UTF-8 safety (matches Linux `/proc/[pid]/cmdline` pattern)
- On any error (ESRCH, EPERM, EINVAL, buffer issues), returns empty `Vec` — best-effort, consistent with the `ProcessInfo.cmdline` contract: "May be empty if command line cannot be read"

**Safety hardening (devrev):**
- PID 0 and overflow-range PIDs (`> i32::MAX`) rejected before sysctl call
- `argc` capped at `MAX_ARGC = 4096` to prevent pathological allocation from malformed kernel data
- Empty argv entries filtered (consistent with Linux `/proc/[pid]/cmdline` behavior)

### FFI: `descendants` and `kill-descendants` Exports

v0.1.12 added `descendants` and `kill-descendants` to the CLI and Rust crates. This release makes them available through the C-ABI FFI layer:

```c
int32_t sysprims_proc_descendants(const char *config_json, char **result_json_out);
int32_t sysprims_proc_kill_descendants(const char *config_json, char **result_json_out);
```

Safety enforcement happens in the FFI layer — bindings get PID 1 protection, self-exclusion, and parent protection for free.

### Go Binding: `Descendants()` and `KillDescendants()`

```go
result, err := sysprims.Descendants(pid, &sysprims.DescendantsOptions{
    MaxLevels: 2,
    Filter: &sysprims.ProcessFilter{Name: "Helper"},
})

killResult, err := sysprims.KillDescendants(pid, &sysprims.KillDescendantsOptions{
    Signal: sysprims.SIGTERM,
    Filter: &sysprims.ProcessFilter{CpuAbove: 80},
    Yes: true,
})
```

### TypeScript Binding: `descendants()` and `killDescendants()`

```typescript
const result = descendants(pid, { maxLevels: 2, filter: { name: "Helper" } });

const killResult = killDescendants(pid, {
    signal: "TERM",
    filter: { cpuAbove: 80 },
    yes: true,
});
```

## Validation

### macOS cmdline Fix

Tested on macOS arm64 (Darwin 25.2.0):

```bash
# Start a background process with known arguments
$ sleep 999 &
$ cargo run -p sysprims-cli -- pstat --pid $! --json | jq '.processes[0].cmdline'
["sleep", "999"]

# Multi-argument process
$ python3 -c "import time; time.sleep(999)" &
$ cargo run -p sysprims-cli -- pstat --pid $! --json | jq '.processes[0].cmdline'
["python3", "-c", "import time; time.sleep(999)"]
```

**Automated test:** `test_own_process_has_cmdline` — verifies the test runner's own process has non-empty cmdline via snapshot.

### Binding Coverage

| Function | FFI | Go | TypeScript |
|----------|:---:|:--:|:----------:|
| `descendants()` | New | New | New |
| `killDescendants()` | New | New | New |

## Platform Notes

### macOS

- `sysctl(CTL_KERN, KERN_PROCARGS2)` requires no special privileges for processes owned by the current user
- For other users' processes, may return empty cmdline (EPERM) — this is expected and consistent with `ps` behavior
- The exec path in the KERN_PROCARGS2 buffer is intentionally skipped; only the actual argv entries are returned

### Linux

- No changes — `/proc/[pid]/cmdline` already worked correctly
- The new `test_own_process_has_cmdline` test is gated to `#[cfg(target_os = "macos")]` since Linux cmdline was never broken

### Windows

- Not in scope for this fix — Windows uses `vec![name]` placeholder, same as the old macOS behavior
- Windows cmdline via `NtQueryInformationProcess` is a separate effort

## Safety Considerations

### PID Validation (ADR-0011)

The `read_cmdline()` function enforces:
- **PID 0** rejected (signals caller's process group)
- **PID > i32::MAX** rejected (would overflow `pid_t` cast)
- **argc validation**: Capped at 4096 to prevent memory exhaustion from malformed data

### Error Handling

All errors in `read_cmdline()` result in an empty `Vec<String>` return — no panics, no error propagation. This is consistent with the `ProcessInfo.cmdline` field contract which documents that cmdline may be empty.

## Upgrade Notes

- **No breaking changes** — all changes are additive
- macOS consumers will immediately see full `cmdline` data where previously truncated
- Consumers filtering by `cmdline` may see more matches than before (this is correct behavior)
- FFI shared library must be rebuilt for all platform targets to include new exports

## Files Changed

- `crates/sysprims-proc/src/macos.rs` — Added `read_cmdline()` function using `sysctl(CTL_KERN, KERN_PROCARGS2)`, replaced placeholder at call site
- `crates/sysprims-proc/src/lib.rs` — Added `test_own_process_has_cmdline` test
- `ffi/sysprims-ffi/src/lib.rs` — Added `descendants` and `kill-descendants` FFI exports
- `ffi/sysprims-ffi/src/proc.rs` — FFI implementation for new exports
- `bindings/go/sysprims/proc.go` — Go binding functions
- `bindings/go/sysprims/include/sysprims.h` — C header for new FFI functions
- `bindings/typescript/sysprims/native/src/lib.rs` — N-API native module
- `bindings/typescript/sysprims/src/ffi.ts` — TypeScript FFI declarations
- `bindings/typescript/sysprims/src/index.ts` — TypeScript public API exports
- `bindings/typescript/sysprims/src/types.ts` — TypeScript type definitions

## References

- **Bug report**: `kitfly/.plans/memos/sysprims/processlist-cmdline-truncated.md`
- **Fix plan**: `.plans/active/v0.1.13/process-name-fidelity.md`
- **Feature brief**: `.plans/active/v0.1.13/feature-brief.md`
- **ADR-0011**: PID Validation Safety
