# v0.1.11 - macOS Port Discovery & Bun Runtime Support

**Release Date:** 2026-02-04
**Status:** macOS Port Discovery & Bun Runtime Support Release

## Summary

This release fixes `listeningPorts()` returning empty results on macOS, adds a new `ports` CLI command for listing listening port bindings, and enables Bun runtime support for TypeScript bindings.

## Highlights

- **macOS Port Discovery Fixed**: `listeningPorts()` now works on macOS
- **New CLI Command**: `sysprims ports` for listing listening port bindings
- **Bun Runtime Support**: TypeScript bindings now work under Bun

## Changes

### CLI: `sysprims ports` Command

New subcommand to list listening port bindings:

```bash
# Table output
sysprims ports --table

# Filter by protocol
sysprims ports --protocol tcp --table

# Filter by specific port (JSON output)
sysprims ports --protocol tcp --local-port 8080 --json
```

**Options:**

| Option                  | Description                 |
| ----------------------- | --------------------------- |
| `--json`                | Output as JSON (default)    |
| `--table`               | Human-readable table format |
| `--protocol <tcp\|udp>` | Filter by protocol          |
| `--local-port <PORT>`   | Filter by local port number |

**Example output (table):**

```
PROTO LOCAL                  STATE        PID NAME
--------------------------------------------------------------------------------
  tcp [::1]:9999             listen     54659 bun
  tcp 0.0.0.0:9000           listen     41721 ssh
  tcp 127.0.0.1:8080         listen     40672 namelens
  ...
```

**Example output (JSON):**

```json
{
  "schema_id": "https://schemas.3leaps.dev/sysprims/process/v1.0.0/port-bindings.schema.json",
  "bindings": [
    {
      "protocol": "tcp",
      "local_addr": "127.0.0.1",
      "local_port": 8080,
      "state": "listen",
      "pid": 40672,
      "process": {
        "pid": 40672,
        "name": "namelens",
        "exe_path": "/Users/.../namelens",
        "cmdline": ["namelens"]
      }
    }
  ],
  "warnings": [...]
}
```

### macOS `listeningPorts()` Fix

The `listeningPorts()` function was returning empty results on macOS due to incorrect socket fdinfo parsing. This release fixes the underlying issues:

**Problem:** SDK struct layout mismatch caused `proc_pidfdinfo(PROC_PIDFDSOCKETINFO)` parsing to fail silently.

**Solution:**

1. **UID Filtering**: Scan current-user processes only
   - Uses `proc_pidinfo(PROC_PIDTBSDINFO)` to read UID cheaply
   - Skips other users' PIDs (reduces EPERM volume)
   - Significantly improves performance and reduces noise

2. **Heuristic Layout Detection**: Handle SDK variations
   - `vinfo_stat` size varies across macOS SDKs (136 vs 144 bytes)
   - New `select_socket_info_layout()` tries common sizes and validates
   - Offset-based parsing instead of fixed struct assumptions

3. **Strict TCP Listener Filtering**: Only return actual listeners
   - Checks `tcpsi_state == TSI_S_LISTEN` for TCP sockets
   - UDP bindings included (UDP has no "listen" state)

**Before (v0.1.10):**

```javascript
const result = listeningPorts();
// result.bindings.length === 0  (empty!)
```

**After (v0.1.11):**

```javascript
const result = listeningPorts();
// result.bindings.length === 68  (working!)
```

### TypeScript Bindings: Bun Runtime Support

Removed the explicit Bun block from `bindings/typescript/sysprims/src/native.ts`:

```typescript
// REMOVED in v0.1.11:
if ((process as unknown as { versions?: { bun?: string } }).versions?.bun) {
  throw new Error(
    "sysprims TypeScript bindings are not yet validated on Bun. " +
      "Run under Node.js or add a fallback path for Bun.",
  );
}
```

Bun's N-API compatibility is mature enough for production use.

## Validation

### macOS Port Discovery

Tested on macOS arm64 (Darwin 25.2.0):

```
$ sysprims ports --protocol tcp --table
PROTO LOCAL                  STATE        PID NAME
--------------------------------------------------------------------------------
  tcp [::1]:9999             listen     54659 bun
  tcp 0.0.0.0:9000           listen     41721 ssh
  tcp 127.0.0.1:8080         listen     40672 namelens
  ... (31 TCP listeners found)
```

Self-listener test passes:

```
$ cargo test -p sysprims-proc test_listening_ports_self_listener_tcp
test test_listening_ports_self_listener_tcp ... ok
```

### Bun Runtime

Validated by kitfly team:

| Feature            | Status                 |
| ------------------ | ---------------------- |
| Module loading     | Works                  |
| `procGet()`        | Works                  |
| `terminate()`      | Works                  |
| `listeningPorts()` | Works (with macOS fix) |

## Platform Notes

### macOS Visibility

Port discovery on macOS is limited to current-user processes due to SIP/TCC restrictions:

- **Visible**: Processes owned by the current user
- **Not visible**: System processes, other users' processes
- **Warnings**: Indicate how many entries were filtered

This is inherent to macOS security model and cannot be bypassed without elevated privileges.

### Linux

Full visibility via `/proc/net/*` - no restrictions for same-user processes.

### Windows

Not yet implemented for `listeningPorts()`.

## Upgrade Notes

- **No breaking changes**
- macOS users will now see port bindings that were previously invisible
- Bun users can use sysprims directly without workarounds
- New `ports` CLI command available

## Files Changed

- `crates/sysprims-cli/src/main.rs` - Added `ports` subcommand (+138 lines)
- `crates/sysprims-proc/src/macos.rs` - Fixed socket fdinfo parsing (~200 lines changed)
- `crates/sysprims-proc/tests/port_bindings.rs` - Tightened macOS self-listener test
- `bindings/typescript/sysprims/src/native.ts` - Removed Bun guard (-6 lines)

## References

- Feature briefs:
  - `.plans/active/v0.1.11/01-macos-listening-ports-reliability.md`
  - `.plans/active/v0.1.11/02-bun-runtime-support.md`
- Commits:
  - `b14b68a` - fix(proc/macos): make listening port discovery reliable
  - `4ca6469` - fix(proc/macos): harden socket fdinfo parsing
  - `96d8c11` - feat(cli): add ports command
