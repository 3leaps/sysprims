# sysprims v0.1.7

**Release Date:** 2026-01-26
**Status:** TypeScript Bindings Infrastructure Release

## Summary

This release migrates TypeScript bindings from koffi FFI to a Node-API (N-API) native addon via napi-rs. The primary user-facing outcome: TypeScript bindings now work in Alpine/musl containers, removing a key blocker for container-based deployments.

## Highlights

- **Node-API Migration**: TypeScript bindings use napi-rs instead of koffi + vendored shared libraries
- **Alpine/musl Support**: Linux musl containers (including Alpine) now supported
- **No API Changes**: Existing TypeScript imports and function calls remain unchanged
- **npm Publishing Deferred**: Prebuilt npm packages planned for future release

## Architecture Change

### Previous Model (v0.1.4-v0.1.6)

```
TypeScript code
    ↓
koffi.load() FFI
    ↓
Vendored C-ABI shared library (_lib/<platform>/libsysprims_ffi.*)
    ↓
Rust FFI exports (sysprims-ffi crate)
```

Limitations:
- koffi's native loading had glibc dependencies that prevented Alpine/musl usage
- Vendored shared libraries added distribution complexity
- Multiple failure modes when loading native code

### New Model (v0.1.7+)

```
TypeScript code
    ↓
require() Node-API addon
    ↓
.node binary built with napi-rs (native/<platform>/)
    ↓
Rust implementation (direct, no C-ABI indirection)
```

Benefits:
- Node-API is designed for native addon portability
- napi-rs provides Rust-native Node-API bindings
- Single binary per platform (`.node` file)
- Works on glibc and musl

## Migration Guide

### For Application Code

**No changes required.** The JavaScript API surface is unchanged:

```typescript
// These imports and calls work identically in v0.1.6 and v0.1.7
import { procGet, processList, terminateTree, spawnInGroup } from '@3leaps/sysprims';

const info = procGet(process.pid);
const procs = processList({ name_contains: 'node' });
```

### For Build/Deploy

#### Installing from Git Checkout (Current)

When installing from a git checkout or local path, the addon must be built from source:

```bash
# Ensure Rust toolchain is available
rustc --version

# Install and build
cd bindings/typescript/sysprims
npm install
npm run build:native
```

**Build requirements:**
- Rust toolchain (1.81+)
- C/C++ compiler (for napi-rs build)
- Node.js 18+

#### Installing from npm (Future)

When npm publishing is enabled, prebuilt platform packages will be installed automatically:

```bash
npm install @3leaps/sysprims
# Prebuilt .node binary selected based on platform
```

No build tools required for npm installs with prebuilds.

### For Container Images

Alpine is now supported. Example Dockerfile:

```dockerfile
FROM node:20-alpine

# For building from source (until npm prebuilds are available)
RUN apk add --no-cache rust cargo build-base

WORKDIR /app
COPY package*.json ./
RUN npm install
RUN npm run build:native

COPY . .
CMD ["node", "index.js"]
```

Once npm prebuilds are available, the Rust/build-base dependencies will be unnecessary.

## What Changed (Implementation Detail)

| Aspect | v0.1.6 (koffi) | v0.1.7 (N-API) |
|--------|----------------|----------------|
| Native loading | `koffi.load()` C-ABI shared lib | `require()` N-API `.node` addon |
| Library location | `_lib/<platform>/libsysprims_ffi.*` | `native/<platform>/sysprims.*.node` |
| Build system | Prebuilt libs vendored in package | napi-rs build from Rust source |
| Error handling | FFI returns error code, JS checks | FFI returns `{ code, json?, message? }` |
| Alpine support | No (glibc required) | Yes |

### Error Handling Internals

The N-API layer returns structured results:

```typescript
// Internal FFI result shape
interface NativeResult {
  code: number;      // 0 = success, >0 = error code
  json?: string;     // JSON payload on success
  message?: string;  // Error message on failure
}
```

The TypeScript wrapper interprets these and throws `SysprimsError` with the same error codes as before, so error handling code is unchanged.

## Platform Support

| Platform | CLI | Go Bindings | TypeScript Bindings |
|----------|-----|-------------|---------------------|
| Linux x64 (glibc) | yes | yes | yes |
| Linux x64 (musl) | yes | yes | **yes** (new) |
| Linux arm64 (glibc) | yes | yes | yes |
| Linux arm64 (musl) | yes | yes | **yes** (new) |
| macOS x64 | no | no | no |
| macOS arm64 | yes | yes | yes |
| Windows x64 | yes | yes | yes |

## CI Validation

The TypeScript bindings are validated by:

1. **TypeScript Bindings workflow** (`typescript-bindings.yml`)
   - Runs on macOS, Windows, Linux (glibc)
   - Includes Alpine/musl container lane
   - Tests all exported functions

2. **Validate Release workflow** (`validate-release.yml`)
   - Post-tag validation
   - Includes TypeScript on all platforms including Alpine

## Adoption Recommendations

### Initial Rollout

1. **Pin to exact version**: `"@3leaps/sysprims": "0.1.7"`
2. **Add smoke test**: Verify addon loads before relying on it
   ```typescript
   import { procGet } from '@3leaps/sysprims';

   // Smoke test at startup
   try {
     procGet(process.pid);
   } catch (e) {
     console.error('sysprims addon failed to load:', e);
     // Fall back to alternative implementation
   }
   ```

### Fallback Strategy

Even with N-API, native addons can fail in edge cases (locked-down environments, unusual Node builds). Consider keeping fallback implementations:

```typescript
let sysprims: typeof import('@3leaps/sysprims') | null = null;

try {
  sysprims = require('@3leaps/sysprims');
} catch {
  console.warn('sysprims unavailable, using fallbacks');
}

export function terminateProcess(pid: number): void {
  if (sysprims) {
    sysprims.terminate(pid);
  } else {
    process.kill(pid, 'SIGTERM');
  }
}
```

### Bun Runtime

Bun has N-API compatibility, but behavior may differ from Node.js. Validate sysprims in Bun-specific test lanes before production use. If issues arise, gate sysprims to Node-only entrypoints.

## Changes

### Changed

- **TypeScript Bindings Architecture** (`bindings/typescript/sysprims/`)
  - Migrated from koffi + vendored C-ABI shared libraries to Node-API (N-API) native addon via napi-rs
  - Prebuilt `.node` binaries loaded from `native/` directory
  - FFI returns `{ code, json?, message? }` internally; JS layer throws `SysprimsError` with same error codes

### Added

- **Linux musl/Alpine Support** (TypeScript)
  - TypeScript bindings now work in Alpine-based containers
  - Removes the "glibc-only" limitation from v0.1.4-v0.1.6

### Notes

- **No API Changes**: Existing TypeScript imports and function calls remain unchanged
- **Build from Source**: Installing from git checkout requires Rust toolchain
- **npm Prebuilds**: Deferred to future release pending consumer validation

## Verification

Verify this release with the signed checksums:

```bash
# Download release and verification files
curl -LO https://github.com/3leaps/sysprims/releases/download/v0.1.7/SHA256SUMS
curl -LO https://github.com/3leaps/sysprims/releases/download/v0.1.7/SHA256SUMS.minisig
curl -LO https://github.com/3leaps/sysprims/releases/download/v0.1.7/sysprims-minisign.pub

# Verify signature
minisign -Vm SHA256SUMS -p sysprims-minisign.pub

# Verify checksums
shasum -a 256 -c SHA256SUMS --ignore-missing
```

## Next Release

v0.1.8+ will continue toward:
- npm publishing with prebuilt platform packages
- Python bindings (cffi + wheel packaging)
- Timeout API for TypeScript (complex config struct)
