name: Release

on:
  push:
    tags: ['v*']

env:
  CARGO_TERM_COLOR: always
  MACOSX_DEPLOYMENT_TARGET: "11.0"

jobs:
  # Validate tag matches VERSION file
  #
  # IMPORTANT: VERSION mismatch is not "just cosmetics".
  # The tag is the canonical semver coordinate for downstream consumers, including
  # language bindings that track X.Y.Z. A mismatch can lead to ambiguous or
  # incorrect version resolution.
  validate-version:
    name: Validate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Validate VERSION matches tag
        id: version
        run: |
          FILE_VERSION=$(cat VERSION)
          TAG_VERSION=${GITHUB_REF_NAME#v}
          if [ "$FILE_VERSION" != "$TAG_VERSION" ]; then
            echo "VERSION mismatch: file=$FILE_VERSION tag=$TAG_VERSION"
            exit 1
          fi
          echo "version=$FILE_VERSION" >> "$GITHUB_OUTPUT"
          echo "Version validated: $FILE_VERSION"

  verify-go-bindings-assets:
    name: Verify Go Binding Assets
    runs-on: ubuntu-latest
    needs: validate-version
    steps:
      - uses: actions/checkout@v4

      - name: Verify Go module contains prebuilt libs
        run: |
          set -euo pipefail

          echo "Verifying Go binding assets are present in this tag commit"

          test -f bindings/go/sysprims/go.mod
          test -f bindings/go/sysprims/include/sysprims.h

          # Go bindings must be usable via `go get` without requiring Rust.
          # The static libs must be present under bindings/go/sysprims/lib/<platform>/.
          for platform in \
            darwin-amd64 \
            darwin-arm64 \
            linux-amd64 \
            linux-amd64-musl \
            linux-arm64 \
            linux-arm64-musl \
            windows-amd64
          do
            path="bindings/go/sysprims/lib/${platform}/libsysprims_ffi.a"
            if [ ! -f "$path" ]; then
              echo "ERROR: missing $path"
              echo "Release tags MUST point at a commit that includes the prebuilt Go binding libs."
              echo "Do not announce this release."
              echo "Fix: merge the go-bindings update commit/PR and re-tag a new version."
              exit 1
            fi
            if [ ! -s "$path" ]; then
              echo "ERROR: empty $path"
              exit 1
            fi
          done

          echo "Go binding assets verified."
  # Build Linux targets using cargo-zigbuild for glibc version targeting
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/fulmenhq/goneat-tools-runner-glibc:v0.3.1
      options: --user root
    needs: validate-version
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            glibc: "2.17"
            artifact_suffix: linux-amd64
          - target: x86_64-unknown-linux-musl
            glibc: ""
            artifact_suffix: linux-amd64-musl
          - target: aarch64-unknown-linux-gnu
            glibc: "2.17"
            artifact_suffix: linux-arm64
          - target: aarch64-unknown-linux-musl
            glibc: ""
            artifact_suffix: linux-arm64-musl
    steps:
      - uses: actions/checkout@v4

      - name: Build CLI
        run: |
          if [ -n "${{ matrix.glibc }}" ]; then
            cargo zigbuild --release --target ${{ matrix.target }}.${{ matrix.glibc }} -p sysprims-cli
          else
            cargo zigbuild --release --target ${{ matrix.target }} -p sysprims-cli
          fi

      - name: Build FFI
        run: |
          if [ -n "${{ matrix.glibc }}" ]; then
            cargo zigbuild --release --target ${{ matrix.target }}.${{ matrix.glibc }} -p sysprims-ffi
          else
            cargo zigbuild --release --target ${{ matrix.target }} -p sysprims-ffi
          fi

      - name: Package CLI
        run: |
          set -euo pipefail

          resolve_target() {
            file="$1"
            candidates=("${{ matrix.target }}")
            if [ -n "${{ matrix.glibc }}" ]; then
              candidates+=("${{ matrix.target }}.${{ matrix.glibc }}")
            fi
            for c in "${candidates[@]}"; do
              if [ -f "target/${c}/release/${file}" ]; then
                echo "$c"
                return 0
              fi
            done
            echo "ERROR: ${file} not found for candidates: ${candidates[*]}" >&2
            find target -maxdepth 4 -path "*/release/${file}" -print || true
            exit 1
          }

          TARGET_DIR="$(resolve_target sysprims)"

          mkdir -p dist/cli
          cp "target/${TARGET_DIR}/release/sysprims" dist/cli/sysprims
          cp LICENSE-MIT LICENSE-APACHE dist/cli/
          VERSION=${{ needs.validate-version.outputs.version }}
          tar -czf sysprims-${VERSION}-${{ matrix.artifact_suffix }}.tar.gz -C dist/cli .

      - name: Package FFI
        run: |
          set -euo pipefail

          resolve_target() {
            file="$1"
            candidates=("${{ matrix.target }}")
            if [ -n "${{ matrix.glibc }}" ]; then
              candidates+=("${{ matrix.target }}.${{ matrix.glibc }}")
            fi
            for c in "${candidates[@]}"; do
              if [ -f "target/${c}/release/${file}" ]; then
                echo "$c"
                return 0
              fi
            done
            echo "ERROR: ${file} not found for candidates: ${candidates[*]}" >&2
            find target -maxdepth 4 -path "*/release/${file}" -print || true
            exit 1
          }

          TARGET_DIR="$(resolve_target libsysprims_ffi.a)"

          mkdir -p dist/ffi/${{ matrix.artifact_suffix }}
          cp "target/${TARGET_DIR}/release/libsysprims_ffi.a" dist/ffi/${{ matrix.artifact_suffix }}/

      - name: Package FFI (shared)
        if: ${{ matrix.glibc != '' }}
        run: |
          set -euo pipefail

          resolve_target() {
            file="$1"
            candidates=("${{ matrix.target }}")
            if [ -n "${{ matrix.glibc }}" ]; then
              candidates+=("${{ matrix.target }}.${{ matrix.glibc }}")
            fi
            for c in "${candidates[@]}"; do
              if [ -f "target/${c}/release/${file}" ]; then
                echo "$c"
                return 0
              fi
            done
            echo "ERROR: ${file} not found for candidates: ${candidates[*]}" >&2
            find target -maxdepth 4 -path "*/release/${file}" -print || true
            exit 1
          }

          TARGET_DIR="$(resolve_target libsysprims_ffi.so)"

          mkdir -p dist/ffi-shared/${{ matrix.artifact_suffix }}
          cp "target/${TARGET_DIR}/release/libsysprims_ffi.so" dist/ffi-shared/${{ matrix.artifact_suffix }}/

      - name: Upload CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: cli-${{ matrix.artifact_suffix }}
          path: sysprims-${{ needs.validate-version.outputs.version }}-${{ matrix.artifact_suffix }}.tar.gz

      - name: Upload FFI artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffi-${{ matrix.artifact_suffix }}
          path: dist/ffi/${{ matrix.artifact_suffix }}

      - name: Upload FFI artifact (shared)
        if: ${{ matrix.glibc != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ffi-shared-${{ matrix.artifact_suffix }}
          path: dist/ffi-shared/${{ matrix.artifact_suffix }}

  # Build macOS targets (cross-compile both from arm64 runner)
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    needs: validate-version
    env:
      MACOSX_DEPLOYMENT_TARGET: "11.0"
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Build CLI (both targets)
        run: |
          cargo build --release --target x86_64-apple-darwin -p sysprims-cli
          cargo build --release --target aarch64-apple-darwin -p sysprims-cli

      - name: Build FFI (both targets)
        run: |
          cargo build --release --target x86_64-apple-darwin -p sysprims-ffi
          cargo build --release --target aarch64-apple-darwin -p sysprims-ffi

      - name: Package CLI (darwin-amd64)
        run: |
          mkdir -p dist/cli-amd64
          cp target/x86_64-apple-darwin/release/sysprims dist/cli-amd64/sysprims
          cp LICENSE-MIT LICENSE-APACHE dist/cli-amd64/
          tar -czf sysprims-${{ needs.validate-version.outputs.version }}-darwin-amd64.tar.gz -C dist/cli-amd64 .

      - name: Package CLI (darwin-arm64)
        run: |
          mkdir -p dist/cli-arm64
          cp target/aarch64-apple-darwin/release/sysprims dist/cli-arm64/sysprims
          cp LICENSE-MIT LICENSE-APACHE dist/cli-arm64/
          tar -czf sysprims-${{ needs.validate-version.outputs.version }}-darwin-arm64.tar.gz -C dist/cli-arm64 .

      - name: Package FFI
        run: |
          mkdir -p dist/ffi/darwin-amd64 dist/ffi/darwin-arm64
          cp target/x86_64-apple-darwin/release/libsysprims_ffi.a dist/ffi/darwin-amd64/
          cp target/aarch64-apple-darwin/release/libsysprims_ffi.a dist/ffi/darwin-arm64/

      - name: Package FFI (shared)
        run: |
          mkdir -p dist/ffi-shared/darwin-amd64 dist/ffi-shared/darwin-arm64
          cp target/x86_64-apple-darwin/release/libsysprims_ffi.dylib dist/ffi-shared/darwin-amd64/
          cp target/aarch64-apple-darwin/release/libsysprims_ffi.dylib dist/ffi-shared/darwin-arm64/

      - name: Upload CLI artifact (darwin-amd64)
        uses: actions/upload-artifact@v4
        with:
          name: cli-darwin-amd64
          path: sysprims-${{ needs.validate-version.outputs.version }}-darwin-amd64.tar.gz

      - name: Upload CLI artifact (darwin-arm64)
        uses: actions/upload-artifact@v4
        with:
          name: cli-darwin-arm64
          path: sysprims-${{ needs.validate-version.outputs.version }}-darwin-arm64.tar.gz

      - name: Upload FFI artifact (darwin-amd64)
        uses: actions/upload-artifact@v4
        with:
          name: ffi-darwin-amd64
          path: dist/ffi/darwin-amd64

      - name: Upload FFI artifact (shared, darwin-amd64)
        uses: actions/upload-artifact@v4
        with:
          name: ffi-shared-darwin-amd64
          path: dist/ffi-shared/darwin-amd64

      - name: Upload FFI artifact (darwin-arm64)
        uses: actions/upload-artifact@v4
        with:
          name: ffi-darwin-arm64
          path: dist/ffi/darwin-arm64

      - name: Upload FFI artifact (shared, darwin-arm64)
        uses: actions/upload-artifact@v4
        with:
          name: ffi-shared-darwin-arm64
          path: dist/ffi-shared/darwin-arm64

  # Build Windows targets using GNU toolchain for CGo compatibility
  # CGo requires MinGW, so we build with x86_64-pc-windows-gnu target
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: validate-version
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-gnu

      - name: Install MinGW
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: mingw-w64-x86_64-gcc
          path-type: inherit

      - name: Build CLI (GNU target)
        shell: msys2 {0}
        run: cargo build --release --target x86_64-pc-windows-gnu -p sysprims-cli

      - name: Build FFI (GNU target)
        shell: msys2 {0}
        run: cargo build --release --target x86_64-pc-windows-gnu -p sysprims-ffi

      - name: Package CLI
        shell: bash
        run: |
          mkdir -p dist/cli
          cp target/x86_64-pc-windows-gnu/release/sysprims.exe dist/cli/sysprims.exe
          cp LICENSE-MIT LICENSE-APACHE dist/cli/
          cd dist/cli && 7z a -tzip ../../sysprims-${{ needs.validate-version.outputs.version }}-windows-amd64.zip .

      - name: Package FFI
        shell: bash
        run: |
          mkdir -p dist/ffi/windows-amd64
          cp target/x86_64-pc-windows-gnu/release/libsysprims_ffi.a dist/ffi/windows-amd64/

      - name: Upload CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: cli-windows-amd64
          path: sysprims-${{ needs.validate-version.outputs.version }}-windows-amd64.zip

      - name: Upload FFI artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffi-windows-amd64
          path: dist/ffi/windows-amd64

  # Build Windows shared library using MSVC toolchain
  # This lane is intended for non-cgo shared-lib consumers.
  build-windows-msvc:
    name: Build Windows (MSVC, shared)
    runs-on: windows-latest
    needs: validate-version
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Build FFI (MSVC target)
        shell: pwsh
        run: cargo build --release --target x86_64-pc-windows-msvc -p sysprims-ffi

      - name: Package FFI (shared)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          New-Item -ItemType Directory -Force -Path dist/ffi-shared/windows-amd64 | Out-Null
          Copy-Item target/x86_64-pc-windows-msvc/release/sysprims_ffi.dll dist/ffi-shared/windows-amd64/

          # Import library name can vary by toolchain version.
          if (Test-Path target/x86_64-pc-windows-msvc/release/sysprims_ffi.dll.lib) {
            Copy-Item target/x86_64-pc-windows-msvc/release/sysprims_ffi.dll.lib dist/ffi-shared/windows-amd64/
          }
          if (Test-Path target/x86_64-pc-windows-msvc/release/sysprims_ffi.lib) {
            Copy-Item target/x86_64-pc-windows-msvc/release/sysprims_ffi.lib dist/ffi-shared/windows-amd64/
          }

      - name: Upload FFI artifact (shared)
        uses: actions/upload-artifact@v4
        with:
          name: ffi-shared-windows-amd64
          path: dist/ffi-shared/windows-amd64

  # Generate C header via cbindgen
  cbindgen:
    name: Generate C Header
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/fulmenhq/goneat-tools-runner-glibc:v0.3.1
      options: --user root
    needs: validate-version
    steps:
      - uses: actions/checkout@v4

      - name: Generate C header
        run: |
          cbindgen --config cbindgen.toml --crate sysprims-ffi --output sysprims.h

      - name: Upload header
        uses: actions/upload-artifact@v4
        with:
          name: c-header
          path: sysprims.h

  # Generate SBOM for compliance (CycloneDX format via Syft)
  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/fulmenhq/sbom-tools:latest
      options: --user 1001
    needs: validate-version
    steps:
      - uses: actions/checkout@v4

      - name: Generate SBOM (CycloneDX)
        run: |
          syft dir:. -o cyclonedx-json > sysprims-${{ needs.validate-version.outputs.version }}.cdx.json

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sysprims-${{ needs.validate-version.outputs.version }}.cdx.json

  # Package all FFI libs into single bundle
  package-ffi-bundle:
    name: Package FFI Bundle
    runs-on: ubuntu-latest
    needs: [validate-version, build-linux, build-macos, build-windows, build-windows-msvc, cbindgen]
    steps:
      - uses: actions/checkout@v4

      - name: Download all FFI artifacts
        uses: actions/download-artifact@v4.1.3
        with:
          pattern: ffi-*
          path: ffi-libs

      - name: Download C header
        uses: actions/download-artifact@v4.1.3
        with:
          name: c-header
          path: ffi-libs

      - name: Package FFI bundle
        run: |
          set -euo pipefail
          shopt -s nullglob
          VERSION=${{ needs.validate-version.outputs.version }}
          mkdir -p bundle/lib bundle/include

          # Organize libs by platform, split by linkage type.
          for dir in ffi-libs/ffi-*/; do
            artifact=$(basename "$dir")

            # Skip shared artifacts in the static loop.
            if [[ "$artifact" == ffi-shared-* ]]; then
              continue
            fi

            platform=${artifact#ffi-}
            mkdir -p "bundle/lib/$platform/static"
            cp "$dir"/* "bundle/lib/$platform/static/" 2>/dev/null || true
          done

          for dir in ffi-libs/ffi-shared-*/; do
            artifact=$(basename "$dir")
            platform=${artifact#ffi-shared-}
            mkdir -p "bundle/lib/$platform/shared"
            cp "$dir"/* "bundle/lib/$platform/shared/" 2>/dev/null || true
          done

          # Add header
          cp ffi-libs/sysprims.h bundle/include/

          # Add metadata
          echo "$VERSION" > bundle/VERSION
          cp LICENSE-MIT LICENSE-APACHE bundle/

          # Create manifest
          cat > bundle/MANIFEST.json << EOF
          {
            "name": "sysprims-ffi",
            "version": "$VERSION",
            "platforms": [
              "linux-amd64",
              "linux-amd64-musl",
              "linux-arm64",
              "linux-arm64-musl",
              "darwin-amd64",
              "darwin-arm64",
              "windows-amd64"
            ]
          }
          EOF

          tar -czf sysprims-ffi-${VERSION}-libs.tar.gz -C bundle .

      - name: Upload FFI bundle
        uses: actions/upload-artifact@v4
        with:
          name: ffi-bundle
          path: sysprims-ffi-${{ needs.validate-version.outputs.version }}-libs.tar.gz

  # Create GitHub release with all artifacts (unsigned - signing is manual)
  publish:
    name: Publish Release
    runs-on: ubuntu-latest
    needs:
      - validate-version
      - verify-go-bindings-assets
      - build-linux
      - build-macos
      - build-windows
      - cbindgen
      - sbom
      - package-ffi-bundle
      - build-windows-msvc
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all CLI artifacts
        uses: actions/download-artifact@v4.1.3
        with:
          pattern: cli-*
          path: release-cli

      - name: Download FFI bundle
        uses: actions/download-artifact@v4.1.3
        with:
          name: ffi-bundle
          path: release-ffi

      - name: Download C header
        uses: actions/download-artifact@v4.1.3
        with:
          name: c-header
          path: release-header

      - name: Download SBOM
        uses: actions/download-artifact@v4.1.3
        with:
          name: sbom
          path: release-sbom

      - name: Organize release files
        run: |
          mkdir -p release

          # CLI archives
          find release-cli -type f \( -name '*.tar.gz' -o -name '*.zip' \) -exec mv {} release/ \;

          # FFI bundle
          mv release-ffi/*.tar.gz release/

          # Header
          mv release-header/sysprims.h release/

          # SBOM
          mv release-sbom/*.json release/

          # Licenses
          cp LICENSE-MIT LICENSE-APACHE release/

          ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          generate_release_notes: true
          draft: true
          body: |
            ## sysprims v${{ needs.validate-version.outputs.version }}

            GPL-free, cross-platform process utilities with group-by-default tree management.

            ### Installation

            Download the appropriate archive for your platform and extract.

            ### Verification

            **Note:** This release is unsigned. Signed checksums will be uploaded after manual signing.

            Once signed artifacts are available:
            ```bash
            # Verify checksum signature
            minisign -Vm SHA256SUMS -p sysprims-minisign.pub

            # Verify file checksums
            shasum -a 256 -c SHA256SUMS
            ```

            ### Platform Matrix

            | Platform | CLI | FFI |
            |----------|-----|-----|
            | Linux x64 (glibc 2.17+) | `sysprims-*-linux-amd64.tar.gz` | In FFI bundle |
            | Linux x64 (musl) | `sysprims-*-linux-amd64-musl.tar.gz` | In FFI bundle |
            | Linux arm64 (glibc 2.17+) | `sysprims-*-linux-arm64.tar.gz` | In FFI bundle |
            | Linux arm64 (musl) | `sysprims-*-linux-arm64-musl.tar.gz` | In FFI bundle |
            | macOS x64 | `sysprims-*-darwin-amd64.tar.gz` | In FFI bundle |
            | macOS arm64 | `sysprims-*-darwin-arm64.tar.gz` | In FFI bundle |
            | Windows x64 | `sysprims-*-windows-amd64.zip` | In FFI bundle |

  # NOTE: Go bindings require committed prebuilt libs under
  # bindings/go/sysprims/lib/<platform>/libsysprims_ffi.a so `go get` works.
  # We prepare those libs via a separate workflow (`go-bindings.yml`) BEFORE tagging.
  #
  # The `verify-go-bindings-assets` job gates this release so we never publish
  # a version where Go can fetch the module but cannot link.
  # (intentionally no job here)
