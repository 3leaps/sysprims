# sysprims - AI Agent Guide

## Read First

1. **READ [`REPOSITORY_SAFETY_PROTOCOLS.md`](REPOSITORY_SAFETY_PROTOCOLS.md) IMMEDIATELY** - this library kills processes; incorrect code kills everything
2. Check `AGENTS.local.md` if it exists (gitignored, tactical session guidance)
3. Read `MAINTAINERS.md` for contacts and governance
4. Review this document for operational protocols
5. Understand: this is a **Rust library with cross-language bindings** - correctness is paramount

> **WARNING**: This repository contains process control code. Tests that use incorrect
> PIDs can terminate system processes including Finder, Terminal, and init. See
> [ADR-0011](docs/decisions/ADR-0011-pid-validation-safety.md) for a real incident
> where `u32::MAX` caused `kill(-1, SIGTERM)` and crashed a desktop session.

## Operating Model

| Aspect         | Setting                                  |
| -------------- | ---------------------------------------- |
| Mode           | Supervised (human reviews before commit) |
| Classification | code-substantive, security-sensitive     |
| Role Required  | Yes                                      |
| Default Role   | devlead                                  |
| Identity       | Per session (no persistent memory)       |

This repository is classified as **security-sensitive** because:

- Process control utilities can affect system stability
- FFI boundary requires careful memory safety
- Signal handling has security implications
- Cross-platform behavior must be predictable

See [agent-identity standard](https://crucible.3leaps.dev/repository/agent-identity) for modes and attribution.

## Project Overview

**sysprims** is a GPL-free, cross-platform process utilities library implemented in Rust with first-class bindings for Go, Python, and TypeScript.

**Core differentiator**: Group-by-default process tree management - when you timeout a process, the entire tree dies.

**Key principle**: Reliable process control without license toxicity.

## Quick Reference

| Task           | Command          |
| -------------- | ---------------- |
| Build          | `cargo build`    |
| Test           | `cargo test`     |
| Format         | `cargo fmt`      |
| Lint           | `cargo clippy`   |
| License check  | `cargo deny check` |
| Security audit | `cargo audit`    |
| Full check     | `make check`     |

## Session Protocol

### Before Changes

- Read relevant code and ADRs first
- Understand cross-platform implications of changes
- Keep changes minimal and focused
- Consider FFI boundary impacts

### Before Committing

- Run `cargo fmt && cargo clippy` (or `make check`)
- Run `cargo test` on available platforms
- Run `cargo deny check licenses`
- Verify no unintended changes with `git diff`
- Use proper commit attribution (see below)

## Commit Attribution

Follow [3leaps commit style](https://crucible.3leaps.dev/repository/commit-style):

```
<type>(<scope>): <subject>

<body>

Generated by <Model> via <Interface> under supervision of @<maintainer>

Co-Authored-By: <Model> <noreply@anthropic.com>
Role: <role>
Committer-of-Record: @<maintainer>
```

**Example:**

```
feat(timeout): implement Job Object fallback on Windows

Adds fallback behavior when Job Object creation fails due to
privilege limits or nested Job Objects.

Changes:
- Add tree_kill_reliability field to TimeoutOutcome
- Implement best-effort termination fallback
- Add observable degradation in JSON output

Generated by Claude Sonnet via Claude Code under supervision of @3leapsdave

Co-Authored-By: Claude Sonnet <noreply@anthropic.com>
Role: devlead
Committer-of-Record: @3leapsdave
```

## Safety Protocols (MANDATORY)

This library terminates processes. Read [`REPOSITORY_SAFETY_PROTOCOLS.md`](REPOSITORY_SAFETY_PROTOCOLS.md) in full.

### Pre-Flight Checklist for Signal-Sending Code

Before writing or modifying any code that **sends signals** or **terminates processes** (`sysprims-signal`, `sysprims-timeout`):

- [ ] I have read [ADR-0011: PID Validation Safety](docs/decisions/ADR-0011-pid-validation-safety.md)
- [ ] I understand `u32::MAX as i32 == -1` (integer overflow)
- [ ] I understand `kill(-1, sig)` broadcasts to ALL processes
- [ ] My tests use safe PIDs: `99999`, `std::process::id()`, or spawned children
- [ ] I am NOT using PID 0, PID 1, or `u32::MAX` in tests
- [ ] I am NOT bypassing public API validation without explicit justification

### Dangerous PID Reference

| Value | Cast to i32 | POSIX Semantics | Safety |
|-------|-------------|-----------------|--------|
| `0` | `0` | Signal caller's process group | **FORBIDDEN** |
| `1` | `1` | Signal init/launchd | **FORBIDDEN** |
| `u32::MAX` | `-1` | Signal ALL processes | **CATASTROPHIC** |
| `> i32::MAX` | Negative | Various broadcast semantics | **FORBIDDEN** |

**If unsure, ask the maintainer before running tests.**

---

## DO / DO NOT

### DO

- Run `cargo fmt && cargo clippy` before commits
- Read files before editing them
- Keep changes focused on the task
- Run tests on all available platforms before PRs
- Document platform-specific behavior
- Consider FFI memory safety implications
- Reference ADRs when making architectural decisions
- Use `#[cfg(unix)]` and `#[cfg(windows)]` appropriately

### DO NOT

- Push without maintainer approval
- Skip quality gates or license checks
- Commit secrets or credentials
- Add GPL/LGPL/AGPL dependencies
- Touch code outside task scope without justification
- Change FFI contracts without ADR review
- Use `unsafe` without clear justification and review
- Assume platform behavior without testing
- **EVER commit anything from `.plans/`** - this directory is gitignored and MUST stay local; planning docs are ephemeral working files, not repository artifacts
- Commit `AGENTS.local.md` (gitignored - session-specific guidance)
- **Use PID 0, 1, or u32::MAX in signal-sending tests** (see Safety Protocols above)
- **Bypass PID validation in signal code without explicit maintainer approval**
- **Run signal-sending tests without verifying target PIDs are safe**

## Critical Rules

### Never Push Without Approval

Git push operations require explicit, per-incident human maintainer approval:

```bash
git add <files>       # OK
git commit -m "..."   # OK
git push              # NEVER without explicit approval
```

### License Compliance

All dependencies must pass `cargo deny check`:

```bash
cargo deny check licenses    # Must pass
cargo deny check advisories  # Must pass
```

See [ADR-0001](docs/decisions/ADR-0001-license-policy.md) for allowed licenses.

### FFI Safety

FFI boundary changes require extra scrutiny:

- Memory ownership must be explicit
- All returned strings freed via `sysprims_free_string()`
- No complex structs across FFI (JSON strings only)
- See [ADR-0004](docs/decisions/ADR-0004-ffi-design.md)

### Platform Parity

Changes must consider all supported platforms:

- Linux (musl + glibc)
- macOS (x64 + arm64)
- Windows (x64)

See [ADR-0007](docs/decisions/ADR-0007-platform-abstraction.md).

## Key Files

| Path                        | Purpose                                    |
| --------------------------- | ------------------------------------------ |
| `REPOSITORY_SAFETY_PROTOCOLS.md` | **MANDATORY** - Process control safety rules |
| `crates/sysprims-core/`     | Shared types, errors, telemetry            |
| `crates/sysprims-timeout/`  | Process timeout with group-by-default      |
| `crates/sysprims-signal/`   | Signal dispatch and process groups         |
| `crates/sysprims-proc/`     | Process inspection and enumeration         |
| `crates/sysprims-cli/`      | CLI binaries                               |
| `ffi/sysprims-ffi/`         | C-ABI exports via cbindgen                 |
| `bindings/`                 | Go, Python, TypeScript wrappers            |
| `docs/decisions/`           | Decision Records (ADR, DDR, SDR)           |
| `docs/safety/`              | Safety guides (signal dispatch, etc.)      |
| `docs/standards/`           | Repository conventions and policies        |
| `deny.toml`                 | License and security policy                |

## Roles

| Role      | Source                                                                 | Customization     |
| --------- | ---------------------------------------------------------------------- | ----------------- |
| `devlead` | [crucible baseline](https://crucible.3leaps.dev/catalog/roles/devlead) | See below         |
| `secrev`  | [crucible baseline](https://crucible.3leaps.dev/catalog/roles/secrev)  | See below         |
| `qa`      | [crucible baseline](https://crucible.3leaps.dev/catalog/roles/qa)      | See below         |
| `releng`  | [crucible baseline](https://crucible.3leaps.dev/catalog/roles/releng)  | -                 |
| `cicd`    | [crucible baseline](https://crucible.3leaps.dev/catalog/roles/cicd)    | -                 |
| `infoarch`| [crucible baseline](https://crucible.3leaps.dev/catalog/roles/infoarch)| -                 |
| `ffiarch` | Project-specific                                                       | See below         |
| `entarch` | Project-specific                                                       | See below         |

### Role: devlead

Extends [crucible devlead baseline](https://crucible.3leaps.dev/catalog/roles/devlead).

#### Additional Scope

- Rust implementation across all crates
- Cross-platform abstraction layer
- Process control semantics (group-by-default)
- Integration with Fulmen ecosystem

### Role: secrev

Extends [crucible secrev baseline](https://crucible.3leaps.dev/catalog/roles/secrev).

#### Additional Scope

- FFI boundary security review
- Signal handling security implications
- Process control privilege boundaries
- Dependency license and vulnerability audits
- Memory safety review for `unsafe` code

### Role: qa

Extends [crucible qa baseline](https://crucible.3leaps.dev/catalog/roles/qa).

#### Additional Scope

- Cross-platform test coverage
- Tree escape integration tests (critical differentiator)
- FFI conformance tests (C, Go, Python, TypeScript)
- Schema validation golden tests

### Role: ffiarch

FFI Architect - Bindings design and cross-language integration.

#### Scope

- C-ABI design and cbindgen configuration
- Language binding implementation (Go, Python, TypeScript)
- Memory ownership contracts across FFI
- JSON schema contracts for bindings

#### Responsibilities

- Design stable FFI interfaces
- Implement binding packages
- Maintain memory safety across language boundaries
- Document binding usage patterns

#### Escalates To

- **devlead** for Rust-side changes
- **Maintainers** for ABI breaking changes
- **secrev** for FFI security review

#### Does Not

- Change core Rust implementation (bindings only)
- Skip FFI conformance tests
- Introduce platform-specific binding behavior without documentation

### Role: entarch

Enterprise Architect - Cross-system integration and Fulmen ecosystem alignment.

#### Scope

- Crucible schema integration
- Fulmen library integration (rsfulmen, gofulmen, pyfulmen, tsfulmen)
- Enterprise deployment patterns
- Cross-repository coordination

#### Responsibilities

- Ensure schema contracts align with Crucible SSOT
- Coordinate with Fulmen ecosystem libraries
- Design enterprise integration patterns
- Document migration paths

#### Escalates To

- **Maintainers** for cross-repository decisions
- **devlead** for implementation details
- **dispatch** for multi-session coordination

#### Does Not

- Implement features (architecture only)
- Change schemas without Crucible coordination
- Make unilateral cross-repo decisions

## ADR Reference

Key architectural decisions:

| ADR | Title | Relevance |
| --- | ----- | --------- |
| [0001](docs/decisions/ADR-0001-license-policy.md) | License Policy | Dependency decisions |
| [0002](docs/decisions/ADR-0002-crate-structure.md) | Crate Structure | Module organization |
| [0003](docs/decisions/ADR-0003-group-by-default.md) | Group-by-Default | Core differentiator |
| [0004](docs/decisions/ADR-0004-ffi-design.md) | FFI Design | Binding architecture |
| [0005](docs/decisions/ADR-0005-schema-contracts.md) | Schema Contracts | JSON output stability |
| [0006](docs/decisions/ADR-0006-dependency-governance.md) | Dependency Governance | SBOM and compliance |
| [0007](docs/decisions/ADR-0007-platform-abstraction.md) | Platform Abstraction | Cross-platform strategy |
| [0008](docs/decisions/ADR-0008-error-handling.md) | Error Handling | Error taxonomy |
| [0011](docs/decisions/ADR-0011-pid-validation-safety.md) | **PID Validation Safety** | **CRITICAL** - Prevents kill(-1) disasters |

## Standards Reference

- **Online**: https://crucible.3leaps.dev/
- **FulmenHQ patterns**: https://github.com/fulmenhq/crucible
- **Local decisions**: `docs/decisions/` (ADR, DDR, SDR)

## Contact

- **Lead maintainer**: See MAINTAINERS.md
- **Repository**: https://github.com/3leaps/sysprims

---

**Last Updated**: December 31, 2025
